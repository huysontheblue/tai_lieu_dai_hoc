
-- ===========================================================
-- Exec_MESReceive,v1.0.0.0,2015/11/10,By Aimee Lu
-- ===========================================================
-- Check In TFS

USE [MESDB]
GO

SET ANSI_NULLS ON
GO

SET QUOTED_IDENTIFIER ON
GO

CREATE PROC [dbo].[Exec_MESReceive]
	@RTVALUE VARCHAR(1) OUTPUT,
	@RTMSG NVARCHAR(128) OUTPUT,
	@OUTCOMPLETEFLAG NVARCHAR(1) OUTPUT,
	@RECEIVEDQTY  NVARCHAR(32) OUTPUT,
	@SCANQTY  NVARCHAR(32) OUTPUT,
	@UNCOLLECTEDQTY  NVARCHAR(32) OUTPUT,
	@USERNAME NVARCHAR(64)='',
	@FACTORYID NVARCHAR(64)='',
	@PROFITCENTER NVARCHAR(32)='',
	@PONO NVARCHAR(32)='',
	@ITEM_NO NVARCHAR(1)='',
	@REEL_BARCODE NVARCHAR(64)='',
	@MATERIAL_NO NVARCHAR(32)='',
	@QTY FLOAT=0,
	@DATECODE NVARCHAR(32)='',
	@RECEIVENO NVARCHAR(32)='',
	@WAREHOUSEID NVARCHAR(32)='',
	@LOCATIONID NVARCHAR(32)='',
	@RECEIVE_TYPE NVARCHAR(32)='',
	@VERSIONS NVARCHAR(32)=''
AS
BEGIN
	SET NOCOUNT ON;
	DECLARE @COMPLETEFLAGE NVARCHAR(1)
	SET @COMPLETEFLAGE='0'
	SET @OUTCOMPLETEFLAG='0'
	
	IF(@PONO IS NULL OR @PONO='')
	BEGIN
		SET @RTMSG='褓尾荒榭'
		SET @RTVALUE='0'
		RETURN;
	END

	--IF(@ITEM_NO IS NULL OR @ITEM_NO='')
	--BEGIN
	--	SET @RTMSG='褓雾不能榭眨'
	--	SET @RTVALUE='0'
	--	RETURN;
	--END

	IF (@REEL_BARCODE IS NULL OR @REEL_BARCODE='')
	BEGIN
		SET @RTMSG='呙栉锪Reella不能榭'
		SET @RTVALUE='2'
		RETURN;
	END

	IF (@MATERIAL_NO IS NULL OR @MATERIAL_NO='')
	BEGIN
		SET @RTMSG='褓雾物料不能榭'
		SET @RTVALUE='3'
		RETURN;
	END

	IF (@LOCATIONID IS NULL OR @LOCATIONID='')
	BEGIN
		SET @RTMSG='呙煳徊荒榭'
		SET @RTVALUE='4'
		RETURN;
	END
	
	--IF NOT EXISTS(SELECT 1 FROM W_RECEIVE_LINES_T WHERE PONO=@PONO AND ITEM_NO=@ITEM_NO AND MATERIAL_NO=@MATERIAL_NO AND STATUS='0')
	--BEGIN
	--	SET @RTMSG='收料失。o法@取褓雾次信息！'
	--	SET @RTVALUE='0'
	--	RETURN;
	--END

	IF EXISTS(SELECT 1 FROM W_REELS_T WHERE REEL_BARCODE=@REEL_BARCODE AND DELETEFLAG='0')
	BEGIN
		SET @RTMSG='物料la：'+@REEL_BARCODE+'已呙'
		SET @RTVALUE='5'
		RETURN;
	END

	DECLARE @RECEIVE_QTY FLOAT
	DECLARE @RQTY FLOAT

	SELECT @RQTY=SUM(ISNULL(QTY,0)), @RECEIVE_QTY=SUM(ISNULL(RECEIVE_QTY,0)) 
	FROM W_PO_LINES_T WHERE PONO=@PONO AND MATERIAL_NO=@MATERIAL_NO 

	IF (@RECEIVE_QTY + CONVERT(FLOAT,@QTY) > @RQTY)
	BEGIN
		SET @RTMSG='收料失。收料盗坎荒艽箪褓盗浚'
		SET @RTVALUE='6'
		RETURN;
	END

	--IF(@RECEIVE_QTY+@QTY=@RQTY)
	--BEGIN
	--	SET @OUTCOMPLETEFLAG='1'
	--END

	BEGIN TRY
	BEGIN TRAN 

	DECLARE @ITEMQTY FLOAT
	DECLARE @ITEMNO NVARCHAR(8)
	DECLARE @RECEIVE_ITEM_NO INT
	DECLARE @UPDATE_QTY FLOAT
	DECLARE @UNIT_MEASURE_ID NVARCHAR(8)
	DECLARE @VENDOR_ID NVARCHAR(16)

	WHILE(@QTY>0) 
	BEGIN
		SELECT TOP 1 @ITEMQTY = (ISNULL(QTY,0)-ISNULL(RECEIVE_QTY,0)), @ITEMNO = CONVERT(NVARCHAR(8),ITEM_NO), @UNIT_MEASURE_ID = UNIT_MEASURE_ID, @VENDOR_ID=VENDOR_ID
		FROM W_PO_LINES_T WHERE PONO=@PONO AND MATERIAL_NO=@MATERIAL_NO ORDER BY QTY - RECEIVE_QTY ASC

		IF(@QTY >= @ITEMQTY)
		BEGIN
			SET @OUTCOMPLETEFLAG = '1'
			SET @UPDATE_QTY=@ITEMQTY
		END
		ELSE
		BEGIN
			SET @UPDATE_QTY = @QTY
			SET @OUTCOMPLETEFLAG = '0'
		END	

		--PRINT CONVERT(VARCHAR,@UPDATE_QTY)+ ' ' +  @PONO + ' ' + @ITEM_NO+ ' ' +  @MATERIAL_NO + ' ' +  @LOCATIONID

		--收料根据库位生成物料批
		IF EXISTS(SELECT 1 FROM W_RECEIVE_LINES_T WHERE PONO=@PONO AND MATERIAL_NO=@MATERIAL_NO AND ITEM_NO=@ITEMNO AND LOCATION=@LOCATIONID AND STATUS='0')
		BEGIN
			-- RECEIVE_ITEM_NO=@RECEIVE_ITEM_NO
		    SELECT @RECEIVE_ITEM_NO = RECEIVE_ITEM_NO FROM W_RECEIVE_LINES_T
			WHERE PONO=@PONO AND MATERIAL_NO=@MATERIAL_NO AND ITEM_NO=@ITEMNO AND LOCATION = @LOCATIONID AND STATUS='0'

			UPDATE W_RECEIVE_LINES_T SET RECEIVE_QTY = RECEIVE_QTY + @UPDATE_QTY,
				QTY = QTY + @UPDATE_QTY
			WHERE PONO=@PONO AND ITEM_NO=@ITEMNO AND MATERIAL_NO=@MATERIAL_NO AND LOCATION = @LOCATIONID AND STATUS='0'
		END
		ELSE
		BEGIN
			IF EXISTS(SELECT 1 FROM W_RECEIVE_LINES_T WHERE PONO=@PONO AND MATERIAL_NO=@MATERIAL_NO AND ITEM_NO=@ITEMNO AND STATUS='0')
			BEGIN
				SELECT @RECEIVE_ITEM_NO = ISNULL(MAX(RECEIVE_ITEM_NO),0) + 1
				FROM W_RECEIVE_LINES_T WHERE PONO=@PONO AND STATUS='0' AND MATERIAL_NO=@MATERIAL_NO AND ITEM_NO=@ITEMNO
			END
			ELSE
			BEGIN
				SELECT @RECEIVE_ITEM_NO = ISNULL(MAX(RECEIVE_ITEM_NO),0) + 1
				FROM W_RECEIVE_LINES_T WHERE PONO=@PONO AND STATUS='0'
			END

			INSERT INTO W_RECEIVE_LINES_T(
				PONO, ITEM_NO, RECEIVENO, RECEIVE_ITEM_NO, MATERIAL_NO, QTY, RECEIVE_QTY, WAREHOUSE, LOCATION, RECEIVE_TYPE,
                MATERIAL_BACHT, STATUS, CONVERSIONFLAG, CREATE_DATE
			)
			VALUES(
				@PONO,@ITEMNO,@RECEIVENO,@RECEIVE_ITEM_NO,@MATERIAL_NO,@UPDATE_QTY,@UPDATE_QTY,@WAREHOUSEID,@LOCATIONID,@RECEIVE_TYPE,NULL,'0','0',GETDATE()
			)
		END

		IF (@OUTCOMPLETEFLAG='1')
		BEGIN
			--RECEIVE_ITEM_NO=@RECEIVE_ITEM_NO 多库位，必须全部完成
			UPDATE W_RECEIVE_LINES_T SET STATUS='1' 
			WHERE PONO=@PONO AND ITEM_NO=@ITEM_NO AND MATERIAL_NO=@MATERIAL_NO AND STATUS='0'

			SET @COMPLETEFLAGE='1'
		END
		
		UPDATE W_PO_LINES_T SET RECEIVE_QTY = RECEIVE_QTY + @UPDATE_QTY 
		WHERE PONO=@PONO AND MATERIAL_NO=@MATERIAL_NO AND ITEM_NO=@ITEMNO

		INSERT INTO W_REELS_T(FACTORY_ID, FACTORY_NAME, PROFITCENTER, REEL_BARCODE, MATERIAL_ID, MATERIAL_NO, SPECIFICATION, 
					DESCRIPTION, UNIT_MEASURE_ID, UOM_NAME, VENDOR_ID, VENDOR_NAME, PONO, ITEM_NO, RECEIVE_ITEM_NO, RECEIVENO, 
					QUANTITY, REMAINING_QUANTITY, WAREHOUSE, LOCATION, LOT_NO, DATECODE, VERSIONS, PARENT_REEL_ID, 
					CREATE_USERID, CREATE_TIME, STATUS, CREATE_DATECODE)
		VALUES(
			@FACTORYID,NULL,@PROFITCENTER,@REEL_BARCODE,@MATERIAL_NO,@MATERIAL_NO,NULL,
			NULL,@UNIT_MEASURE_ID,@UNIT_MEASURE_ID,@VENDOR_ID,@VENDOR_ID,@PONO,@ITEMNO,@RECEIVE_ITEM_NO,@RECEIVENO,
			@QTY,@QTY,@WAREHOUSEID,@LOCATIONID,NULL,@DATECODE, @VERSIONS,@REEL_BARCODE,
			@USERNAME,GETDATE(),'1',CONVERT(VARCHAR(100), GETDATE(), 12) 
		)

		--出入库记录
		INSERT INTO W_OUTSTORAGERECORD_T(
			FACTORY_ID, FACTORY_NAME, PROFITCENTER, TRANSACTION_NO, REEL_BARCODE, MATERIAL_ID, MATERIAL_NO, 
                QUANTITY, WARHOUSE, LOCATION, TYPE, USER_ID, CREATE_TIME
		)VALUES(
			@FACTORYID,NULL,@PROFITCENTER, @PONO,@REEL_BARCODE,@MATERIAL_NO,@MATERIAL_NO,
			@QTY,@WAREHOUSEID,@LOCATIONID, '0', @USERNAME, GETDATE()
		)
		SET @QTY = @QTY - @ITEMQTY
	END

	SET @OUTCOMPLETEFLAG = @COMPLETEFLAGE
	SET @RTMSG=''
	SET @RTVALUE='1'
	--@RECEIVEDQTY 	已收数	@SCANQTY 扫描数 	@UNCOLLECTEDQTY  未收数

	SELECT @RECEIVEDQTY = CONVERT(NVARCHAR(16),ISNULL(W_PO_LINES_T.RECEIVE_QTY,0)), 
		@SCANQTY =CONVERT(NVARCHAR(16),CONVERT(INT,ISNULL(W_RECEIVE_LINES_T.QTY,0))), 
		@UNCOLLECTEDQTY = CONVERT(NVARCHAR(16),ISNULL(W_PO_LINES_T.QTY,0)-ISNULL(W_PO_LINES_T.RECEIVE_QTY,0))
	FROM W_RECEIVE_LINES_T 
		INNER JOIN W_PO_LINES_T ON W_PO_LINES_T.PONO=W_RECEIVE_LINES_T.PONO 
			AND  W_PO_LINES_T.MATERIAL_NO=W_RECEIVE_LINES_T.MATERIAL_NO AND W_PO_LINES_T.ITEM_NO=W_RECEIVE_LINES_T.ITEM_NO
	WHERE W_RECEIVE_LINES_T.PONO=@PONO AND W_RECEIVE_LINES_T.MATERIAL_NO=@MATERIAL_NO AND W_RECEIVE_LINES_T.ITEM_NO=@ITEMNO AND LOCATION=@LOCATIONID

	SELECT REEL_BARCODE,MATERIAL_ID,QUANTITY,STATUS FROM W_REELS_T 
	WHERE PONO=@PONO AND MATERIAL_NO=@MATERIAL_NO AND ITEM_NO=@ITEMNO AND LOCATION=@LOCATIONID

	COMMIT TRAN
	END TRY 
	BEGIN CATCH 
		ROLLBACK TRAN 
		SET @RTMSG='绦惺。M_l人T！'
		SET @RTVALUE='7'
	END CATCH 

	--IF (@@ERROR>0)
	--BEGIN
	--	ROLLBACK TRAN  
	--	SET @RTMSG='绦惺。M_l人T！'
	--	SET @RTVALUE='0'
	--END
	--ELSE
	--BEGIN
	--	SET @RTMSG=''
	--	SET @RTVALUE='1'

	--	COMMIT TRAN
	--END

END


GO


