
-- ===========================================================
-- Exec_AddedLocationScan,v1.0.0.0,2015/11/10,By Aimee Lu
-- ===========================================================
-- Check In TFS

USE [MESDB]
GO

SET ANSI_NULLS ON
GO

SET QUOTED_IDENTIFIER ON
GO



CREATE PROC [dbo].[Exec_AddedLocationScan]
	@RTVALUE VARCHAR(1) OUTPUT,
	@RTMSG NVARCHAR(128) OUTPUT,
	@QUANTITY NVARCHAR(32) OUTPUT,
	@ADDLOCATIONQUANTITY  NVARCHAR(32) OUTPUT,
	@FACTORYID NVARCHAR(64)='',
	@PROFITCENTER NVARCHAR(32)='',
	@USERID NVARCHAR(64)='',
	@SCANTYPE VARCHAR(8)='',
	@ORDERNO VARCHAR(32)='',
	@WAREHOUSELOCATIONID NVARCHAR(32)='',
	@BARCODE NVARCHAR(64)=''
AS
BEGIN
	SET NOCOUNT ON;
	SET @QUANTITY = 0
	SET @ADDLOCATIONQUANTITY = 0

	--@SCANTYPE： 0：非成品，1：成品
	IF (@WAREHOUSELOCATIONID IS NULL OR @WAREHOUSELOCATIONID='')
	BEGIN
		SET @RTMSG=N'呙煳徊荒榭'
		SET @RTVALUE='0'
		RETURN;
	END

	IF (@BARCODE IS NULL OR @BARCODE='')
	BEGIN
		SET @RTMSG=N'呙栉锪Reella不能榭'
		SET @RTVALUE='0'
		RETURN;
	END

	IF NOT EXISTS(SELECT 1 FROM m_WarehouseLocation_t WHERE WarehouseLocationCode = @WAREHOUSELOCATIONID AND StatusFlag='1')
	BEGIN
		SET @RTMSG=N'煳呙璨淮嬖诨o效'
		--SET @RTMSG=@WAREHOUSELOCATIONID
		SET @RTVALUE='0'
		RETURN;
	END

	IF NOT EXISTS(SELECT 1 FROM W_REELS_T WHERE REEL_BARCODE = @BARCODE AND DELETEFLAG = '0' AND STATUS = '1' AND CheckUserId IS NULL AND LOCATION = @WAREHOUSELOCATIONID)
	BEGIN
	--SET @RTMSG=@BARCODE 
		SET @RTMSG=N'呙栉锪Reel不存在/已上架完成/上架库位不符'
		SET @RTVALUE='0'
		RETURN;
	END
	
	BEGIN TRY
	BEGIN TRAN 
		UPDATE W_REELS_T SET CheckUserId = @USERID, CheckWarehouseLocationId = @WAREHOUSELOCATIONID, CheckTime = GETDATE() 
		WHERE REEL_BARCODE = @BARCODE
		SET @RTVALUE='1'
		SET @RTMSG=''
	COMMIT TRAN
	END TRY 
	BEGIN CATCH 
		ROLLBACK TRAN 
		SET @RTMSG=N'绦惺。M_l人T！'
		SET @RTVALUE='0'
	END CATCH 
END
GO


